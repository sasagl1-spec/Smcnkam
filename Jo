# Telegram –∫–∞–Ω–∞–ª –º–æ–¥—É–ª–µ–π: https://t.me/modulesTheHika
# –°–æ–∑–¥–∞—Ç–µ–ª—å: @vipqlkxn

from hikka import loader, utils
from telethon.tl.functions.messages import SendMessageRequest
from telethon.tl.functions.contacts import ResolveUsernameRequest
from telethon.tl.types import KeyboardButtonCallback
from telethon.tl.functions.messages import GetBotCallbackAnswerRequest
import asyncio

@loader.tds
class GramPiarInlineMod(loader.Module):
    """–†–∞–±–æ—Ç–∞ —Å –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∞–º–∏ @gram_piarbot"""
    strings = {"name": "GramPiarInline"}

    async def client_ready(self, client, db):
        self._client = client
        self._db = db
        self.bot_username = "gram_piarbot"

    async def click_inline_button(self, button_text):
        """–ù–∞–∂–∞—Ç–∏–µ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏ –ø–æ —Ç–µ–∫—Å—Ç—É"""
        try:
            bot_entity = await self._client(ResolveUsernameRequest(self.bot_username))
            bot_input = await self._client.get_input_entity(bot_entity.peer)
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞
            async for msg in self._client.iter_messages(bot_input, limit=1):
                if not msg.out and msg.buttons:
                    # –ò—â–µ–º –Ω—É–∂–Ω—É—é –∫–Ω–æ–ø–∫—É
                    for row in msg.buttons:
                        for button in row:
                            if hasattr(button, 'text') and button_text in button.text:
                                if isinstance(button, KeyboardButtonCallback):
                                    # –ù–∞–∂–∏–º–∞–µ–º callback –∫–Ω–æ–ø–∫—É
                                    await self._client(GetBotCallbackAnswerRequest(
                                        peer=bot_input,
                                        msg_id=msg.id,
                                        data=button.data
                                    ))
                                    return True
                    break
            return False
        except Exception as e:
            print(f"Error clicking button: {e}")
            return False

    @loader.command()
    async def inlineearncmd(self, message):
        """–ù–∞–∂–∞—Ç—å –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å' - .inlineearn"""
        try:
            # –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º /start –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–µ–Ω—é
            await self._client(SendMessageRequest(
                peer=await self._client.get_input_entity(self.bot_username),
                message="/start",
                no_webpage=True
            ))
            await asyncio.sleep(2)

            # –ù–∞–∂–∏–º–∞–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É "–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å"
            success = await self.click_inline_button("–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å")
            if success:
                await utils.answer(message, "‚úÖ –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å'")
                await asyncio.sleep(2)
                
                # –¢–µ–ø–µ—Ä—å –Ω–∞–∂–∏–º–∞–µ–º "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª"
                channel_success = await self.click_inline_button("–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª")
                if channel_success:
                    await utils.answer(message, "‚úÖ –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª'")
                    
                    # –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
                    await asyncio.sleep(3)
                    await self.handle_subscription()
                else:
                    await utils.answer(message, "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª'")
            else:
                await utils.answer(message, "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å'")

        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")

    async def handle_subscription(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª—ã"""
        try:
            bot_entity = await self._client(ResolveUsernameRequest(self.bot_username))
            bot_input = await self._client.get_input_entity(bot_entity.peer)
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ–¥–ø–∏—Å–∫–∏
            async for msg in self._client.iter_messages(bot_input, limit=1):
                if not msg.out and msg.buttons:
                    # –ò—â–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ (–æ–±—ã—á–Ω–æ —Å –∏–∫–æ–Ω–∫–æ–π üìå –∏–ª–∏ ‚úÖ)
                    for row in msg.buttons:
                        for button in row:
                            if hasattr(button, 'text') and ('–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è' in button.text or 'Subscribe' in button.text):
                                if isinstance(button, KeyboardButtonCallback):
                                    await self._client(GetBotCallbackAnswerRequest(
                                        peer=bot_input,
                                        msg_id=msg.id,
                                        data=button.data
                                    ))
                                    await utils.answer(message, "‚úÖ –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏")
                                    return True
                    break
            return False
        except Exception as e:
            print(f"Subscription error: {e}")
            return False

    @loader.command()
    async def inlinebtncmd(self, message):
        """–ù–∞–∂–∞—Ç—å –ª—é–±—É—é –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É - .inlinebtn <—Ç–µ–∫—Å—Ç>"""
        args = utils.get_args_raw(message)
        if not args:
            await utils.answer(message, "‚ùå –£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏\n–ü—Ä–∏–º–µ—Ä: .inlinebtn –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª")
            return

        success = await self.click_inline_button(args)
        if success:
            await utils.answer(message, f"‚úÖ –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞: {args}")
        else:
            await utils.answer(message, f"‚ùå –ö–Ω–æ–ø–∫–∞ '{args}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

    @loader.command()
    async def refreshcmd(self, message):
        """–û–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é –±–æ—Ç–∞ - .refresh"""
        try:
            await self._client(SendMessageRequest(
                peer=await self._client.get_input_entity(self.bot_username),
                message="/start",
                no_webpage=True
            ))
            await utils.answer(message, "üîÑ –ú–µ–Ω—é –±–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ")
        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
