# Telegram –∫–∞–Ω–∞–ª –º–æ–¥—É–ª–µ–π: https://t.me/modulesTheHika
# –°–æ–∑–¥–∞—Ç–µ–ª—å: @vipqlkxn

from hikka import loader, utils
from telethon.tl.functions.messages import SendMessageRequest
from telethon.tl.functions.contacts import ResolveUsernameRequest
import asyncio
import re

@loader.tds
class GramPiarAutoEarnMod(loader.Module):
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫ –≤ @gram_piarbot"""
    strings = {"name": "GramPiarAutoEarn"}

    async def client_ready(self, client, db):
        self._client = client
        self._db = db
        self.bot_username = "gram_piarbot"
        self.completed_tasks = []

    async def send_to_bot(self, message_text):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç—É –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞"""
        try:
            bot_entity = await self._client(ResolveUsernameRequest(self.bot_username))
            bot_input = await self._client.get_input_entity(bot_entity.peer)
            
            await self._client(SendMessageRequest(
                peer=bot_input,
                message=message_text,
                no_webpage=True
            ))
            
            await asyncio.sleep(3)
            async for msg in self._client.iter_messages(bot_input, limit=1):
                if not msg.out:
                    return msg.text
            return None
        except Exception:
            return None

    @loader.command()
    async def earnsubcmd(self, message):
        """–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å ‚Üí –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª - .earnsub"""
        try:
            # –®–∞–≥ 1: –ù–∞–∂–∏–º–∞–µ–º "–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å"
            await utils.answer(message, "üîÑ –ù–∞–∂–∏–º–∞—é '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å'...")
            earn_response = await self.send_to_bot("–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å")
            
            if not earn_response:
                await utils.answer(message, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å'")
                return

            # –®–∞–≥ 2: –ù–∞–∂–∏–º–∞–µ–º "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª"
            await utils.answer(message, "üìå –ù–∞–∂–∏–º–∞—é '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª'...")
            sub_response = await self.send_to_bot("–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª")
            
            if not sub_response:
                await utils.answer(message, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª'")
                return

            # –®–∞–≥ 3: –ü–∞—Ä—Å–∏–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
            channel_links = re.findall(r'(https?://t\.me/\S+|@\w+)', sub_response)
            
            if not channel_links:
                await utils.answer(message, "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏")
                return

            # –®–∞–≥ 4: –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫–∞–Ω–∞–ª
            target_channel = channel_links[0]
            await utils.answer(message, f"üîó –ü–æ–¥–ø–∏—Å—ã–≤–∞—é—Å—å –Ω–∞: {target_channel}")
            
            sub_result = await self.send_to_bot(target_channel)
            await asyncio.sleep(2)
            
            # –®–∞–≥ 5: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É
            confirm_result = await self.send_to_bot("‚úÖ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è")
            
            if confirm_result and ("–ø—Ä–æ–≤–µ—Ä–∫–∞" in confirm_result.lower() or "—É—Å–ø–µ—à–Ω–æ" in confirm_result.lower()):
                self.completed_tasks.append(target_channel)
                await utils.answer(message, f"‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ –∫–∞–Ω–∞–ª!\nüìä –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π: {len(self.completed_tasks)}")
            else:
                await utils.answer(message, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É")

        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")

    @loader.command()
    async def earnstatuscmd(self, message):
        """–°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π - .earnstatus"""
        if not self.completed_tasks:
            await utils.answer(message, "üìä –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π: 0")
            return
        
        last_tasks = "\n".join(self.completed_tasks[-5:])
        await utils.answer(message, f"üìä –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π: {len(self.completed_tasks)}\n\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ:\n{last_tasks}")

    @loader.command()
    async def earnclearcmd(self, message):
        """–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–¥–∞–Ω–∏–π - .earnclear"""
        self.completed_tasks.clear()
        await utils.answer(message, "üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞–Ω–∏–π –æ—á–∏—â–µ–Ω–∞")

    @loader.command()
    async def earnautocmd(self, message):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º - .earnauto"""
        try:
            await utils.answer(message, "ü§ñ –ó–∞–ø—É—Å–∫–∞—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º...")
            
            for i in range(5):  # –ú–∞–∫—Å–∏–º—É–º 5 –∑–∞–¥–∞–Ω–∏–π –∑–∞ —Ä–∞–∑
                await self.earnsubcmd(message)
                await asyncio.sleep(5)
                
            await utils.answer(message, f"‚úÖ –ê–≤—Ç–æ—Ä–µ–∂–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω\n–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π: {len(self.completed_tasks)}")
            
        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–µ–∂–∏–º–∞: {str(e)}")
