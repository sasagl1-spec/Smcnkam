# Telegram –∫–∞–Ω–∞–ª –º–æ–¥—É–ª–µ–π: https://t.me/modulesTheHika
# –°–æ–∑–¥–∞—Ç–µ–ª—å: @vipqlkxn

from hikka import loader, utils
from telethon.tl.functions.messages import SendMessageRequest
from telethon.tl.functions.contacts import ResolveUsernameRequest
from telethon.tl.types import KeyboardButton, KeyboardButtonCallback
from telethon.tl.functions.messages import GetBotCallbackAnswerRequest
import asyncio
import re

@loader.tds
class GramPiarFullAutoMod(loader.Module):
    """–ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è @gram_piarbot"""
    strings = {"name": "GramPiarFullAuto"}

    async def client_ready(self, client, db):
        self._client = client
        self._db = db
        self.bot_username = "gram_piarbot"
        self.completed_tasks = []

    async def get_bot_messages(self, limit=5):
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞"""
        try:
            bot_entity = await self._client(ResolveUsernameRequest(self.bot_username))
            bot_input = await self._client.get_input_entity(bot_entity.peer)
            
            messages = []
            async for msg in self._client.iter_messages(bot_input, limit=limit):
                if not msg.out:
                    messages.append(msg)
            return messages
        except Exception:
            return []

    async def find_and_click_button(self, button_text, message=None):
        """–ù–∞–π—Ç–∏ –∏ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ —Ç–µ–∫—Å—Ç—É"""
        try:
            if not message:
                messages = await self.get_bot_messages(1)
                if not messages:
                    return False
                message = messages[0]

            if not message.buttons:
                return False

            for row in message.buttons:
                for button in row:
                    if hasattr(button, 'text') and button_text in button.text:
                        if isinstance(button, KeyboardButton):
                            # –û–±—ã—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
                            await self._client(SendMessageRequest(
                                peer=await self._client.get_input_entity(self.bot_username),
                                message=button.text,
                                no_webpage=True
                            ))
                            return True
                        elif isinstance(button, KeyboardButtonCallback):
                            # Callback –∫–Ω–æ–ø–∫–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º callback
                            await self._client(GetBotCallbackAnswerRequest(
                                peer=await self._client.get_input_entity(self.bot_username),
                                msg_id=message.id,
                                data=button.data
                            ))
                            return True
            return False
        except Exception:
            return False

    @loader.command()
    async def fullautocmd(self, message):
        """–ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è - .fullauto"""
        try:
            # –®–∞–≥ 1: /start
            await utils.answer(message, "üöÄ –ó–∞–ø—É—Å–∫–∞—é /start...")
            await self._client(SendMessageRequest(
                peer=await self._client.get_input_entity(self.bot_username),
                message="/start",
                no_webpage=True
            ))
            await asyncio.sleep(3)

            # –®–∞–≥ 2: –ù–∞–∂–∏–º–∞–µ–º "–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å" –≤ –º–µ–Ω—é
            await utils.answer(message, "üí∞ –ù–∞–∂–∏–º–∞—é '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å'...")
            earn_success = await self.find_and_click_button("–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å")
            if not earn_success:
                await utils.answer(message, "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å'")
                return
            await asyncio.sleep(3)

            # –®–∞–≥ 3: –ù–∞–∂–∏–º–∞–µ–º "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª"
            await utils.answer(message, "üìå –ù–∞–∂–∏–º–∞—é '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª'...")
            channel_success = await self.find_and_click_button("–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª")
            if not channel_success:
                await utils.answer(message, "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª'")
                return
            await asyncio.sleep(3)

            # –®–∞–≥ 4: –ò—â–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è" –≤ –ª–µ–≤–æ–º —Å—Ç–æ–ª–±—Ü–µ
            await utils.answer(message, "üîç –ò—â—É –∫–Ω–æ–ø–∫—É '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'...")
            messages = await self.get_bot_messages(3)
            sub_success = False
            
            for msg in messages:
                if msg.buttons:
                    for row in msg.buttons:
                        for button in row:
                            if hasattr(button, 'text') and "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è" in button.text and "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å" not in button.text:
                                sub_success = await self.find_and_click_button(button.text, msg)
                                if sub_success:
                                    break
                        if sub_success:
                            break
                    if sub_success:
                        break
            
            if not sub_success:
                await utils.answer(message, "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'")
                return
            await asyncio.sleep(5)

            # –®–∞–≥ 5: –ò—â–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å" –≤ –ø—Ä–∞–≤–æ–º —Å—Ç–æ–ª–±—Ü–µ
            await utils.answer(message, "‚úÖ –ò—â—É –∫–Ω–æ–ø–∫—É '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å'...")
            check_success = False
            messages = await self.get_bot_messages(3)
            
            for msg in messages:
                if msg.buttons:
                    for row in msg.buttons:
                        for button in row:
                            if hasattr(button, 'text') and "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å" in button.text:
                                check_success = await self.find_and_click_button(button.text, msg)
                                if check_success:
                                    break
                        if check_success:
                            break
                    if check_success:
                        break

            if check_success:
                await utils.answer(message, "üéâ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.")
                self.completed_tasks.append("‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ")
            else:
                await utils.answer(message, "‚ö†Ô∏è –í—ã–ø–æ–ª–Ω–µ–Ω–æ, –Ω–æ –∫–Ω–æ–ø–∫–∞ '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")

    @loader.command()
    async def autostatuscmd(self, message):
        """–°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π - .autostatus"""
        if not self.completed_tasks:
            await utils.answer(message, "üìä –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π: 0")
            return
        
        await utils.answer(message, f"üìä –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π: {len(self.completed_tasks)}")

    @loader.command()
    async def autorestcmd(self, message):
        """–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ - .autorest"""
        try:
            await self._client(SendMessageRequest(
                peer=await self._client.get_input_entity(self.bot_username),
                message="/start",
                no_webpage=True
            ))
            await utils.answer(message, "üîÑ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω")
        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
