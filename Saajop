# Telegram –∫–∞–Ω–∞–ª –º–æ–¥—É–ª–µ–π: https://t.me/modulesTheHika
# –°–æ–∑–¥–∞—Ç–µ–ª—å: @vipqlkxn

from hikka import loader, utils
from telethon.tl.functions.messages import SendMessageRequest
from telethon.tl.functions.contacts import ResolveUsernameRequest
from telethon.tl.types import KeyboardButton, KeyboardButtonCallback
from telethon.tl.functions.messages import GetBotCallbackAnswerRequest
from telethon.tl.functions.channels import JoinChannelRequest
import asyncio
import re

@loader.tds
class GramPiarFullAutoMod(loader.Module):
    """–ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ @gram_piarbot"""
    strings = {"name": "GramPiarFullAuto"}

    async def client_ready(self, client, db):
        self._client = client
        self._db = db
        self.bot_username = "gram_piarbot"
        self.completed_tasks = []
        self.current_channel = None

    async def get_bot_message(self):
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞"""
        try:
            bot_entity = await self._client(ResolveUsernameRequest(self.bot_username))
            bot_input = await self._client.get_input_entity(bot_entity.peer)
            
            async for msg in self._client.iter_messages(bot_input, limit=1):
                if not msg.out:
                    return msg
            return None
        except Exception:
            return None

    async def click_button(self, button_text):
        """–ù–∞–π—Ç–∏ –∏ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ —Ç–µ–∫—Å—Ç—É"""
        try:
            msg = await self.get_bot_message()
            if not msg or not msg.buttons:
                return False

            for row in msg.buttons:
                for button in row:
                    if hasattr(button, 'text') and button_text in button.text:
                        if isinstance(button, KeyboardButton):
                            await self._client(SendMessageRequest(
                                peer=await self._client.get_input_entity(self.bot_username),
                                message=button.text,
                                no_webpage=True
                            ))
                            return True
                        elif isinstance(button, KeyboardButtonCallback):
                            await self._client(GetBotCallbackAnswerRequest(
                                peer=await self._client.get_input_entity(self.bot_username),
                                msg_id=msg.id,
                                data=button.data
                            ))
                            return True
            return False
        except Exception:
            return False

    async def extract_channel_link(self):
        """–ò–∑–≤–ª–µ—á—å —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–Ω–∞–ª –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞"""
        try:
            msg = await self.get_bot_message()
            if not msg:
                return None

            # –ò—â–µ–º —Å—Å—ã–ª–∫–∏ –≤ —Ç–µ–∫—Å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            links = re.findall(r'(https?://t\.me/\S+|@\w+)', msg.text)
            return links[0] if links else None
        except Exception:
            return None

    async def join_channel(self, channel_link):
        """–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª"""
        try:
            if channel_link.startswith('@'):
                # –î–ª—è username —Ñ–æ—Ä–º–∞—Ç–∞ @channel
                await self._client(JoinChannelRequest(channel_link))
            elif 't.me/' in channel_link:
                # –î–ª—è –ø–æ–ª–Ω–æ–π —Å—Å—ã–ª–∫–∏ https://t.me/channel
                username = channel_link.split('/')[-1]
                if username.startswith('+'):
                    username = username[1:]
                await self._client(JoinChannelRequest(f'@{username}'))
            
            self.current_channel = channel_link
            return True
        except Exception as e:
            print(f"Join error: {e}")
            return False

    async def complete_task(self):
        """–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è"""
        try:
            # –®–∞–≥ 1: –ù–∞–∂–∏–º–∞–µ–º "–ü–æ–¥–ø–∏—Å–∞—Ç—å"
            await utils.answer(message, "üìå –ù–∞–∂–∏–º–∞—é '–ü–æ–¥–ø–∏—Å–∞—Ç—å'...")
            if not await self.click_button("–ü–æ–¥–ø–∏—Å–∞—Ç—å"):
                return False

            # –ñ–¥–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –∫–∞–Ω–∞–ª
            await asyncio.sleep(3)

            # –®–∞–≥ 2: –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–Ω–∞–ª
            channel_link = await self.extract_channel_link()
            if not channel_link:
                await utils.answer(message, "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª")
                return False

            # –®–∞–≥ 3: –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∫–∞–Ω–∞–ª
            await utils.answer(message, f"üîó –ü–æ–¥–ø–∏—Å—ã–≤–∞—é—Å—å –Ω–∞: {channel_link}")
            if not await self.join_channel(channel_link):
                await utils.answer(message, "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª")
                return False

            # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
            await asyncio.sleep(2)

            # –®–∞–≥ 4: –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –±–æ—Ç—É
            await self._client(SendMessageRequest(
                peer=await self._client.get_input_entity(self.bot_username),
                message="/start",
                no_webpage=True
            ))
            await asyncio.sleep(2)

            # –®–∞–≥ 5: –°–Ω–æ–≤–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∑–∞–¥–∞–Ω–∏—è
            await self.click_button("–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å")
            await asyncio.sleep(2)
            await self.click_button("–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª")
            await asyncio.sleep(3)

            # –®–∞–≥ 6: –ù–∞–∂–∏–º–∞–µ–º "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å"
            await utils.answer(message, "‚úÖ –ù–∞–∂–∏–º–∞—é '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å'...")
            if not await self.click_button("–ü—Ä–æ–≤–µ—Ä–∏—Ç—å"):
                return False

            # –ñ–¥–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
            await asyncio.sleep(3)
            return True

        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {str(e)}")
            return False

    @loader.command()
    async def fulltaskcmd(self, message):
        """–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ - .fulltask"""
        try:
            success = await self.complete_task()
            if success:
                self.completed_tasks.append(f"‚úÖ {self.current_channel}")
                await utils.answer(message, f"üéâ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! –ö–∞–Ω–∞–ª: {self.current_channel}")
            else:
                await utils.answer(message, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ")

        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")

    @loader.command()
    async def autotaskcmd(self, message):
        """–ê–≤—Ç–æ—Ä–µ–∂–∏–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π - .autotask <N>"""
        try:
            args = utils.get_args_raw(message)
            count = int(args) if args and args.isdigit() else 1
            count = min(count, 5)  # –ú–∞–∫—Å–∏–º—É–º 5 –∑–∞–¥–∞–Ω–∏–π

            await utils.answer(message, f"ü§ñ –ó–∞–ø—É—Å–∫–∞—é {count} –∑–∞–¥–∞–Ω–∏–π...")
            
            successful = 0
            for i in range(count):
                await utils.answer(message, f"üîß –ó–∞–¥–∞–Ω–∏–µ {i+1}/{count}...")
                if await self.complete_task():
                    successful += 1
                    self.completed_tasks.append(f"‚úÖ –ó–∞–¥–∞–Ω–∏–µ {i+1}")
                await asyncio.sleep(3)

            await utils.answer(message, f"üìä –í—ã–ø–æ–ª–Ω–µ–Ω–æ: {successful}/{count} –∑–∞–¥–∞–Ω–∏–π")

        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")

    @loader.command()
    async def taskinfocmd(self, message):
        """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º –∑–∞–¥–∞–Ω–∏–∏ - .taskinfo"""
        try:
            msg = await self.get_bot_message()
            if not msg:
                await utils.answer(message, "‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞")
                return

            # –ò—â–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞–Ω–∏—è—Ö
            task_info = ""
            if "–ü–æ–¥–ø–∏—Å–∞—Ç—å" in msg.text and "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å" in msg.text:
                task_info = "üìã –î–æ—Å—Ç—É–ø–Ω—ã –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏"
            
            # –ò—â–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª—ã
            links = re.findall(r'(https?://t\.me/\S+|@\w+)', msg.text)
            if links:
                task_info += f"\nüîó –ù–∞–π–¥–µ–Ω–æ –∫–∞–Ω–∞–ª–æ–≤: {len(links)}"

            await utils.answer(message, task_info if task_info else "‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–¥–∞–Ω–∏—è—Ö")

        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")

    @loader.command()
    async def resumecmd(self, message):
        """–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–∞ - .resume"""
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ
            if self.current_channel:
                await utils.answer(message, f"üîÑ –ü—Ä–æ–¥–æ–ª–∂–∞—é —Å –∫–∞–Ω–∞–ª–∞: {self.current_channel}")
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –±–æ—Ç—É –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
                await self._client(SendMessageRequest(
                    peer=await self._client.get_input_entity(self.bot_username),
                    message="/start",
                    no_webpage=True
                ))
                await asyncio.sleep(2)
                await self.click_button("–ü—Ä–æ–≤–µ—Ä–∏—Ç—å")
            else:
                await utils.answer(message, "‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è")

        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
