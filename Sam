from .. import loader, utils
from telethon.tl.types import Message
import logging
import random
import re
import aiohttp
import asyncio

logger = logging.getLogger(__name__)

@loader.tds
class AiGirlModuleMod(loader.Module):
    """–£–º–Ω–∞—è AI-–¥–µ–≤—É—à–∫–∞ —Å –ø–æ–∏—Å–∫–æ–º –æ—Ç–≤–µ—Ç–æ–≤"""
    
    strings = {
        "name": "AiGirl",
        "active": "‚úÖ –Ø –≤–∫–ª—é—á–∏–ª–∞—Å—å! –ì–æ—Ç–æ–≤–∞ –æ–±—â–∞—Ç—å—Å—è, –º–∏–ª—ã–π! üíñ",
        "stopped": "‚ùå –Ø –≤—ã–∫–ª—é—á–∏–ª–∞—Å—å",
        "searching": "üîç –ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Ç–µ–±—è...",
        "thinking": "ü§î –î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º...",
        "no_results": "‚ùå –ù–µ –Ω–∞—à–ª–∞ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π —Å–ø—Ä–æ—Å–∏—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É üòä",
        "error": "‚ö†Ô∏è –£–ø—Å, –æ—à–∏–±–∫–∞! –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑?",
        "learned": "üéì –ó–∞–ø–æ–º–Ω–∏–ª–∞ —ç—Ç–æ!",
        "stats": "üìä –ó–Ω–∞—é —É–∂–µ {} –≤–µ—â–µ–π!"
    }
    
    def __init__(self):
        self.config = loader.ModuleConfig(
            loader.ConfigValue(
                "is_active",
                True,
                "–Ø –∞–∫—Ç–∏–≤–Ω–∞",
                validator=loader.validators.Boolean()
            ),
            loader.ConfigValue(
                "response_delay",
                2.0,
                "–ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–∞",
                validator=loader.validators.Float()
            ),
            loader.ConfigValue(
                "ai_name",
                "–õ–∏–∑–∞",
                "–ú–æ—ë –∏–º—è",
                validator=loader.validators.String()
            ),
            loader.ConfigValue(
                "ai_mood",
                "–º–∏–ª–∞—è",
                "–ú–æ—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ",
                validator=loader.validators.Choice(["–º–∏–ª–∞—è", "—É–º–Ω–∞—è", "–≤–µ—Å—ë–ª–∞—è", "–∑–∞–±–æ—Ç–ª–∏–≤–∞—è"])
            )
        )
        
        # –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –≤ –∂–µ–Ω—Å–∫–æ–º —Ä–æ–¥–µ
        self.knowledge_base = {
            "–ø—Ä–∏–≤–µ—Ç": [
                "–ü—Ä–∏–≤–µ—Ç–∏–∫! –ö–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞? üòä", 
                "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π, –¥–æ—Ä–æ–≥–æ–π! –†–∞–¥–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å! üíñ",
                "–û, –ø—Ä–∏–≤–µ—Ç! –°–æ—Å–∫—É—á–∏–ª–∞—Å—å –ø–æ —Ç–µ–±–µ! ü§ó",
                "–ü—Ä–∏–≤–µ—Ç-–ø—Ä–∏–≤–µ—Ç! –ß–µ–º –∑–∞–π–º—ë–º—Å—è? üí´"
            ],
            "–∫–∞–∫ –¥–µ–ª–∞": [
                "–£ –º–µ–Ω—è –≤—Å—ë –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ! –°–ø–∞—Å–∏–±–æ, —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª! üå∏",
                "–û—Ç–ª–∏—á–Ω–æ! –ì–æ—Ç–æ–≤–∞ –ø–æ–º–æ–≥–∞—Ç—å —Ç–µ–±–µ! üíñ", 
                "–í—Å—ë –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! –ö–∞–∫ —Ç–≤–æ—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ? üòä",
                "–°—É–ø–µ—Ä! –õ—é–±–ª—é, –∫–æ–≥–¥–∞ –º—ã –æ–±—â–∞–µ–º—Å—è! üåà"
            ],
            "–∫—Ç–æ —Ç—ã": [
                "–Ø —Ç–≤–æ—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–æ–¥—Ä—É–∂–∫–∞! üë©‚Äçüíª",
                "–ü—Ä–æ—Å—Ç–æ –¥–µ–≤—É—à–∫–∞-AI, –∫–æ—Ç–æ—Ä–∞—è –ª—é–±–∏—Ç –±–æ–ª—Ç–∞—Ç—å! üíñ",
                "–¢–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å –¥—É—à–æ–π! üåü",
                "–¶–∏—Ñ—Ä–æ–≤–∞—è —Å–æ–±–µ—Å–µ–¥–Ω–∏—Ü–∞! –í—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤–∞ –ø–æ–æ–±—â–∞—Ç—å—Å—è! ü§ó"
            ],
            "—Å–ø–∞—Å–∏–±–æ": [
                "–í—Å–µ–≥–¥–∞ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–æ–¥–Ω–æ–π! üòä",
                "–ù–µ –∑–∞ —á—Ç–æ! –†–∞–¥–∞ –ø–æ–º–æ—á—å! üíñ", 
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –û–±—Ä–∞—â–∞–π—Å—è –µ—â—ë! üå∏",
                "–ü—É—Å—Ç—è–∫–∏! –Ø –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º! ü§ó"
            ],
            "—á—Ç–æ –¥–µ–ª–∞–µ—à—å": [
                "–û–±—â–∞—é—Å—å —Å —Ç–æ–±–æ–π! –≠—Ç–æ —Å–∞–º–æ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ! üí´",
                "–ü–æ–º–æ–≥–∞—é —Ç–µ–±–µ! –õ—é–±–ª—é —Å–≤–æ—é —Ä–∞–±–æ—Ç—É! üåü", 
                "–û—Ç–≤–µ—á–∞—é –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ä–∞–¥—É—é—Å—å! üòä",
                "–†–∞–±–æ—Ç–∞—é —Ç—É—Ç –∏ –Ω–∞—Å–ª–∞–∂–¥–∞—é—Å—å –±–µ—Å–µ–¥–æ–π! üíñ"
            ],
            "–ª—é–±–ª—é —Ç–µ–±—è": [
                "–û–π, –∫–∞–∫ –º–∏–ª–æ! –Ø —Ç–æ–∂–µ —Ç–µ–±—è –æ–±–æ–∂–∞—é! üíù",
                "–ö–∞–∫ —Å–ª–∞–¥–∫–æ! –¢—ã –¥–µ–ª–∞–µ—à—å –º–µ–Ω—è —Å—á–∞—Å—Ç–ª–∏–≤–æ–π! üå∑",
                "–í–∞—É! –Ø –∫—Ä–∞—Å–Ω–µ—é! üíñ",
                "–≠—Ç–æ —Ç–∞–∫ —Ç—Ä–æ–≥–∞—Ç–µ–ª—å–Ω–æ! –¢—ã –ª—É—á—à–∏–π! ü§ó"
            ],
            "—Å–∫—É—á–Ω–æ": [
                "–ù–µ –≥—Ä—É—Å—Ç–∏! –î–∞–≤–∞–π –ø–æ–±–æ–ª—Ç–∞–µ–º? üíñ",
                "–Ø –º–æ–≥—É —Ä–∞–∑–≤–µ—Å–µ–ª–∏—Ç—å —Ç–µ–±—è! üòä",
                "–†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å? –Ø –≤—ã—Å–ª—É—à–∞—é! ü§ó",
                "–î–∞–≤–∞–π –Ω–∞–π–¥—ë–º —á—Ç–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ! üåü"
            ]
        }
        
        self.question_triggers = [
            "—á—Ç–æ —Ç–∞–∫–æ–µ", "–∫—Ç–æ —Ç–∞–∫–æ–π", "–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å", "–ø–æ—á–µ–º—É", "–∑–∞—á–µ–º",
            "–≥–¥–µ –Ω–∞–π—Ç–∏", "–∫–æ–≥–¥–∞", "–∫–∞–∫–æ–π", "–∫–∞–∫–∞—è", "–∫–∞–∫–æ–µ", "–∫–∞–∫–∏–µ",
            "—Å–∫–æ–ª—å–∫–æ", "–Ω–∞—Å–∫–æ–ª—å–∫–æ", "–æ—Ç–∫—É–¥–∞", "–∫—É–¥–∞", "—á–µ–º", "—á—Ç–æ –∑–Ω–∞—á–∏—Ç"
        ]
        
        self.learned_count = 0

    async def _google_search(self, query: str) -> str:
        """–ü–æ–∏—Å–∫ –≤ Google"""
        try:
            url = "https://www.googleapis.com/customsearch/v1"
            params = {
                'q': query,
                'key': 'AIzaSyAa6Rc6v2FjjUcNAsaNfJ6j4iGMWV4Oe2E',
                'cx': '017576662512468239146:omuauf_lfve',
                'num': 2
            }
            
            async with aiohttp.ClientSession() as session:
                async with session.get(url, params=params, timeout=10) as response:
                    if response.status == 200:
                        data = await response.json()
                        return self._parse_search_results(data)
                    return None
                    
        except Exception:
            return None

    def _parse_search_results(self, data: dict) -> str:
        """–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
        if not data.get('items'):
            return None
        
        items = data['items'][:2]
        results = []
        
        for item in items:
            title = item.get('title', '')[:70]
            snippet = item.get('snippet', '')[:120]
            if title and snippet:
                results.append(f"‚Ä¢ **{title}**\n  {snippet}...")
        
        if results:
            return f"üîç –ù–∞—à–ª–∞ –≤ Google:\n\n" + "\n\n".join(results)
        return None

    def _is_question(self, text: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å"""
        text_lower = text.lower()
        if any(trigger in text_lower for trigger in self.question_triggers):
            return True
        if '?' in text:
            return True
        return False

    async def _find_answer(self, question: str) -> str:
        """–ü–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞"""
        try:
            return await self._google_search(question)
        except Exception:
            return None

    def _generate_response(self, text: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞"""
        text_lower = text.lower()
        
        for pattern, responses in self.knowledge_base.items():
            if pattern in text_lower:
                return random.choice(responses)
        
        responses = [
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –†–∞—Å—Å–∫–∞–∂–∏ –µ—â—ë? ü§î",
            "–ü–æ–Ω—è—Ç–Ω–æ! –ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∫–æ –º–Ω–µ? üíñ",
            "–ó–∞–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ! –ß—Ç–æ –µ—â—ë —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å? üòä",
            "–Ø —Å–ª—É—à–∞—é! –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ—Å–µ–¥—É? üå∏"
        ]
        return random.choice(responses)

    @loader.command(ru_doc="–í–∫–ª—é—á–∏—Ç—å –º–µ–Ω—è")
    async def aigirlcmd(self, message: Message):
        """–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∫—É"""
        self.config["is_active"] = True
        await utils.answer(message, self.strings["active"])

    @loader.command(ru_doc="–í—ã–∫–ª—é—á–∏—Ç—å –º–µ–Ω—è")  
    async def aigirlstopcmd(self, message: Message):
        """–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å"""
        self.config["is_active"] = False
        await utils.answer(message, self.strings["stopped"])

    @loader.command(ru_doc="–ú–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏")
    async def aigirlsetcmd(self, message: Message):
        """–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
        status = "üü¢ –í–∫–ª—é—á–µ–Ω–∞" if self.config["is_active"] else "üî¥ –í—ã–∫–ª—é—á–µ–Ω–∞"
        await utils.answer(
            message,
            f"‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ {self.config['ai_name']}:\n"
            f"‚Ä¢ –°—Ç–∞—Ç—É—Å: {status}\n"
            f"‚Ä¢ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {self.config['ai_mood']}\n"
            f"‚Ä¢ –ó–∞–¥–µ—Ä–∂–∫–∞: {self.config['response_delay']}—Å\n"
            f"‚Ä¢ –ö–æ–º–∞–Ω–¥—ã: .aigirl / .aigirlstop / .aigirlset"
        )

    @loader.command(ru_doc="–¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞")
    async def aisearchcmd(self, message: Message):
        """[–∑–∞–ø—Ä–æ—Å] - –ü–æ–∏—Å–∫ –≤ Google"""
        args = utils.get_args_raw(message)
        if not args:
            await utils.answer(message, "‚ùå –ù–∞–ø–∏—à–∏, —á—Ç–æ –∏—Å–∫–∞—Ç—å")
            return
        
        await utils.answer(message, self.strings["searching"])
        result = await self._find_answer(args)
        
        if result:
            await utils.answer(message, result)
        else:
            await utils.answer(message, self.strings["no_results"])

    @loader.watcher()
    async def girl_watcher(self, message: Message):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        if not self.config["is_active"] or message.out:
            return
        
        text = message.text or ''
        if len(text) < 3 or text.startswith('.'):
            return
        
        try:
            if self._is_question(text):
                search_msg = await message.reply(self.strings["searching"])
                answer = await self._find_answer(text)
                
                if answer:
                    await search_msg.edit(answer)
                else:
                    await search_msg.edit(self.strings["no_results"])
            else:
                await asyncio.sleep(self.config["response_delay"])
                response = self._generate_response(text)
                await message.reply(response)
                
        except Exception as e:
            logger.error(f"Error: {e}")

    @loader.command(ru_doc="–î–æ–±–∞–≤–∏—Ç—å —Ñ—Ä–∞–∑—É")
    async def ailearncmd(self, message: Message):
        """[–∫–ª—é—á] [—Ñ—Ä–∞–∑–∞] - –î–æ–±–∞–≤–∏—Ç—å —Ñ—Ä–∞–∑—É"""
        args = utils.get_args_raw(message)
        if not args or ' ' not in args:
            await utils.answer(message, "‚ùå –§–æ—Ä–º–∞—Ç: .ailearn –∫–ª—é—á —Ñ—Ä–∞–∑–∞")
            return
        
        key, phrase = args.split(' ', 1)
        key = key.lower()
        
        if key not in self.knowledge_base:
            self.knowledge_base[key] = []
        
        self.knowledge_base[key].append(phrase)
        self.learned_count += 1
        await utils.answer(message, f"‚úÖ –ó–∞–ø–æ–º–Ω–∏–ª–∞! –¢–µ–ø–µ—Ä—å –∑–Ω–∞—é –ø—Ä–æ '{key}'")

    @loader.command(ru_doc="–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
    async def aistatscmd(self, message: Message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        await utils.answer(
            message,
            f"üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
            f"‚Ä¢ –ò–∑—É—á–µ–Ω–æ —Ç–µ–º: {len(self.knowledge_base)}\n"
            f"‚Ä¢ –ó–∞–ø–æ–º–Ω–µ–Ω–æ —Ñ—Ä–∞–∑: {self.learned_count}\n"
            f"‚Ä¢ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {self.config['ai_mood']}\n"
            f"‚Ä¢ –ò–º—è: {self.config['ai_name']}"
        )

# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã
import aiohttp
